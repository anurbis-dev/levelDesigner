# Changelog

## [3.19.8] - 2025-01-27

### Fixed
- **View Menu Checkboxes** - исправлено обновление чекбоксов панелей в меню View при скрытии тулбара через контекстное меню
- **Game Mode Checkboxes** - исправлено обновление чекбокса Game Mode при деактивации режима
- **Game Mode Menu** - добавлено автоматическое закрытие меню View при отключении Game Mode
- **Panel State Restoration** - исправлен порядок вызовов при выходе из Game Mode для корректного обновления чекбоксов
- **Null Reference Error** - исправлена ошибка "Cannot read properties of null (reading 'style')" в restorePanelStates()

### Improved
- **Checkbox Synchronization** - улучшена синхронизация состояний чекбоксов между различными UI элементами
- **Game Mode UX** - улучшен пользовательский опыт при переключении Game Mode

## [3.19.7] - 2025-09-26

### Fixed
- **Конфигурации пользователя** - добавлены недостающие файлы editor.json и panels.json в config/user/
- **Структура настроек** - теперь пользовательские настройки полностью соответствуют дефолтным

### Improved
- **Очистка кода** - удалены неиспользуемые конфигурационные файлы (assets, camera, performance, selection, toolbar, view)
- **Очистка кода** - удален неиспользуемый IsometricGridRenderer
- **Очистка кода** - удалены example файлы из config/user/
- **Документация** - обновлена структура папок в README

## [3.19.6] - 2025-09-26

### Fixed
- **Удаление слоев** - исправлена ошибка "moveObjectsToMainLayer is not a function" при удалении слоев
- **Контекстное меню слоев** - исправлена проблема с определением слоя под курсором при клике на вложенные элементы
- **API методов** - исправлено использование правильного метода getLayerObjects() вместо несуществующего getObjectsForLayer()

### Improved
- **Надежность удаления** - добавлен метод moveObjectsToMainLayer() для корректного перемещения объектов при удалении слоя
- **Обработка событий** - улучшена обработка событий контекстного меню с использованием closest() для поиска элемента слоя
- **Код** - удалены все отладочные логи из MouseHandlers.js и LayersPanel.js

## [3.19.5] - 2025-09-26

### Fixed
- **Diamond Grid при зуме** - исправлена некорректная отрисовка при зуме камеры
- **Центральные линии при рестарте** - исправлена проблема с отсутствием центральных линий при камере в позиции (0,0)
- **Расчет spacing** - убрана двойная корректировка spacing (трансформация камеры уже применяется в CanvasRenderer)
- **Точность вычислений** - добавлены проверки isFinite() для предотвращения NaN в расчетах пересечений

### Improved
- **Стабильность отрисовки** - diamond grid теперь стабильно работает при всех уровнях зума
- **Обработка граничных случаев** - улучшена обработка линий, проходящих через углы viewport
- **Производительность** - убраны отладочные логи, засоряющие консоль

## [3.19.4] - 2025-09-26

### Fixed
- **Diamond Grid отрисовка** - исправлена проблема с неполным покрытием viewport линиями
- **Зависимость от зума камеры** - добавлена корректировка spacing линий при разных уровнях зума
- **Расчет диапазона линий** - улучшен алгоритм расчета с учетом всех углов viewport

### Improved
- **Полное покрытие viewport** - diamond grid теперь правильно рисует все линии по всему окну
- **Адаптивная плотность** - spacing линий корректируется в зависимости от зума для оптимальной видимости
- **Точность пересечений** - оптимизирован расчет точек пересечения линий с границами видимости

## [3.19.3] - 2025-01-27

### Fixed
- **Контекстное меню тулбара** - исправлено отображение сепаратора и пунктов меню
- **Порядок элементов меню** - Settings всегда остается внизу списка
- **Подсветка текущего типа** - выбранный тип грида подсвечивается синим вместо дизейбла
- **Стабильность меню** - элементы не "прыгают" при обновлении типов гридов

### Improved
- **Обработка сепараторов** - добавлена поддержка `type: 'separator'` в BaseContextMenu
- **Динамическое обновление** - контекстное меню корректно обновляется при смене типа грида
- **Правильная очистка** - `clearGridTypeMenuItems()` удаляет только элементы гридов

## [3.19.2] - 2025-01-27

### Added
- **Карусельное переключение типов гридов** - Ctrl+Click на кнопке Grid для переключения между типами
- **Динамические иконки гридов** - иконка кнопки Grid меняется в зависимости от выбранного типа
- **Автоматическое определение типов гридов** - система автоматически подхватывает доступные рендереры
- **Конфигурируемые иконки** - легко настраиваемые иконки для каждого типа грида
- **Сохранение выбранного типа** - выбранный тип грида сохраняется в пользовательских настройках

### Improved
- **Гибкая архитектура** - код автоматически адаптируется к изменениям в списке рендереров
- **Fallback система** - graceful обработка отсутствующих рендереров
- **Единый стиль иконок** - все иконки гридов в едином геометрическом стиле

### Technical
- **Динамическая инициализация** - `initializeGridTypes()` получает типы из CanvasRenderer
- **Автоматическое обновление** - `refreshGridTypes()` для обновления при изменении рендереров
- **Конфигурационная система** - `gridTypeConfig` Map для хранения настроек типов

## [3.19.1] - 2025-01-27

### Added
- **Модульная архитектура рендеринга сетки** - разделение рендереров по типам сетки
- **BaseGridRenderer** - базовый класс с общей логикой для всех типов сетки
- **RectangularGridRenderer** - специализированный рендерер прямоугольной сетки
- **DiamondGridRenderer** - специализированный рендерер diamond сетки (60°/120°)
- **HexagonalGridRenderer** - специализированный рендерер шестиугольной сетки
- **Унифицированное API** - единый интерфейс для всех типов сетки
- **Общая логика стилизации** - централизованная обработка цветов и толщины линий

### Refactored
- **Убрано дублирование кода** - общая логика вынесена в BaseGridRenderer
- **Упрощена архитектура** - удален промежуточный слой GridRenderer.js
- **Встроена логика выбора рендерера** - интегрирована в CanvasRenderer.drawGrid()
- **Оптимизирована производительность** - устранены лишние вызовы и дублирование

### Fixed
- **Исправлено позиционирование сетки** - устранено двойное применение камеры
- **Исправлена логика изометрической сетки** - правильные углы 60° и 120°
- **Устранены конфликты импортов** - чистая система зависимостей

## [3.19.0] - 2025-01-27

### Added
- **Сохранение позиции скролла тулбара** - автоматическое запоминание позиции прокрутки
- **Восстановление позиции скролла** - позиция восстанавливается при перезагрузке редактора
- **Сохранение при скролле колесом** - позиция сохраняется при прокрутке колесом мыши
- **Сохранение при завершении перетаскивания** - позиция сохраняется при отпускании мыши

### Fixed
- **Исправлена видимость удаленных объектов** - объекты корректно исчезают с canvas после удаления
- **Исправлено сохранение размера консоли** - размер сохраняется только при отпускании мыши, а не при каждом движении
- **Исправлено восстановление позиции тулбара** - позиция скролла корректно восстанавливается при инициализации

### Improved
- **Оптимизировано сохранение настроек** - снижена частота сохранения при изменении размера консоли
- **Улучшена система инвалидации кешей** - добавлена инвалидация пространственного индекса при удалении объектов

## [3.18.0] - 2025-01-27

### Added
- **Настраиваемый snap tolerance** - адаптивная зона притяжения к сетке (5-100%)
- **Сохранение snap tolerance** - настройка сохраняется в пользовательских предпочтениях
- **Единая логика снэпа** - консистентное поведение для перетаскивания, дублирования и drop объектов
- **Централизованный SnapUtils** - единая точка управления логикой снэпа

### Fixed
- **Исправлен снэп дубликатов** - левый нижний угол первого объекта попадает в точку грида
- **Исправлена логика позиционирования** - дубликаты используют правильную точку привязки
- **Устранен дублирующий код** - централизован метод findNearestGridPoint

### Improved
- **Оптимизирована производительность** - кеширование мировых позиций объектов
- **Улучшена консистентность** - все операции снэпа используют одинаковую логику
- **Упрощен код** - удален дублирующий код, улучшена читаемость

### Changed
- **Обновлена архитектура снэпа** - используется существующая логика из dragSelectedObjects
- **Изменена точка привязки** - дубликаты привязываются к позиции курсора, снэп к левому нижнему углу
- **Обновлены пользовательские настройки** - добавлен snapTolerance в UserPreferencesManager

## [3.17.0] - 2025-01-27

### Added
- Добавлен функционал выделения строк в консоли левым клик-драгом
- Добавлено контекстное меню для копирования выделенного текста в консоли
- Добавлены CSS стили для визуального выделения текста в консоли
- Добавлена поддержка двойного клика для выделения всей строки в консоли
- Добавлены клавиатурные сочетания (Ctrl+A, Escape) для работы с выделением

### Fixed
- Исправлена ошибка `ReferenceError: levelId is not defined` в RenderOperations.js
- Исправлено автоматическое сбрасывание выделения текста в консоли
- Исправлены фризы редактора при выделении текста в консоли
- Исправлена работа командной строки консоли при активном выделении
- Исправлена синхронизация пользовательских настроек между сессиями

### Improved
- Оптимизирована производительность выделения текста в консоли
- Улучшена логика определения выделенных строк с использованием throttling
- Упрощена система обработки событий выделения для лучшей производительности
- Удалены лишние debug логи для улучшения производительности
- Улучшена визуальная обратная связь при выделении текста

### Changed
- Обновлена система выделения текста - теперь использует глобальный обработчик вместо множественных локальных
- Улучшена система кэширования состояния выделения для предотвращения лишних обновлений DOM
- Оптимизирована работа с контекстным меню консоли

## [3.16.1] - 2025-01-27

### Fixed
- Исправлено сохранение и восстановление настроек грида при перезапуске редактора
- Исправлено отображение цветов грида в настройках - теперь корректно конвертируются между hex и rgba форматами
- Исправлен сброс настроек грида на дефолтные - теперь применяется синхронизация с GridSettings
- Устранено дублирование функций конвертации цветов - централизованы в RenderUtils
- Удалены лишние логи работы грида для улучшения производительности

### Changed
- Улучшена система загрузки настроек грида - добавлена секция 'grid' в список загружаемых конфигураций
- Оптимизирована конвертация цветов - все функции перенесены в централизованные утилиты

## [3.16.0] - 2025-09-24

### Fixed
- Исправлено панорамирование тулбара средней кнопкой мыши - теперь работает на всем тулбаре включая активные и неактивные кнопки
- Убрано "прилипание" курсора при панорамировании - теперь обычное панорамирование в противоположном направлении движению курсора

### Changed
- Улучшена обработка событий на disabled кнопках тулбара - pointer-events: none позволяет событиям проходить сквозь неактивные элементы

## [3.15.0] - 2025-09-24

### Fixed
- Исправлено отображение canvas при изменении видимости toolbar - теперь canvas автоматически адаптируется под новое доступное пространство
- Исправлено закрытие контекстного меню toolbar при активации команды "Hide" - меню теперь закрывается сразу после выполнения действия
- Убрано лишнее логирование в системе toolbar для оптимизации производительности

### Changed
- Улучшена синхронизация между UI элементами toolbar и системой управления панелями
- Оптимизирована инициализация состояния toolbar с canvas renderer

## [3.14.0] - 2024-12-19

### Added
- Полная система сохранения пользовательских настроек тулбара
- Запоминание состояния кнопок тулбара (Grid, Snap, Parallax, Boundaries, Collisions)
- Запоминание свернутых секций тулбара (File, Edit, View, Group)
- Запоминание настроек отображения (иконки и текст кнопок)
- Запоминание видимости тулбара
- Автоматическое сохранение настроек в localStorage
- Восстановление всех настроек при перезагрузке редактора

### Changed
- Улучшена инициализация тулбара - отрисовывается сразу в правильном состоянии
- Устранено визуальное "переключение" тулбара при загрузке настроек
- Оптимизирована система загрузки состояния тулбара
- Улучшена синхронизация состояния кнопок с StateManager

### Fixed
- Исправлена проблема с инверсным отображением кнопки Boundaries
- Устранена задержка при переключении состояния кнопок тулбара
- Исправлена синхронизация визуального состояния с реальным состоянием функций

## [3.13.0] - 2024-12-19

### Added
- Горизонтальное разделение рабочей области с тулбаром в верхней части
- Полнофункциональный тулбар с кнопками управления (File, Edit, View, Tools, Group)
- Сворачиваемые секции тулбара по клику на заголовок
- Контекстное меню тулбара с командами Hide, Icons, Text
- Горизонтальный скроллинг тулбара (колесо мыши + средний клик)
- Управление видимостью иконок и текста кнопок тулбара
- Интеграция тулбара в систему управления панелями

### Changed
- Переработана структура HTML layout для горизонтального разделения
- Тулбар перемещен в верхнюю часть рабочей области
- Обновлена система управления видимостью панелей для тулбара
- Улучшена интеграция тулбара с Game Mode

### Fixed
- Исправлено позиционирование контекстного меню тулбара (открывается вниз)
- Улучшена синхронизация состояний тулбара с меню View
- Оптимизированы стили тулбара для новой позиции

## [3.11.0] - 2024-12-19

### Added
- Улучшенная система контекстных меню с централизованным управлением
- Оптимизированные стили для всех контекстных меню (BaseContextMenu, ConsoleContextMenu)
- Улучшенная функциональность OutlinerContextMenu с исправленными багами

### Changed
- Обновлена система стилей контекстных меню для лучшей совместимости
- Улучшена производительность отображения контекстных меню

### Fixed
- Исправлены проблемы с отображением контекстных меню
- Устранены баги в OutlinerContextMenu
- Улучшена стабильность работы с контекстными меню

## [3.10.0] - 2024-12-19

### Added
- Система констрейна оси при перетаскивании объектов с зажатым Shift
- Визуальное отображение оси констрейна с настраиваемыми параметрами
- Настройки оси констрейна в панели настроек (цвет, толщина, включение/отключение)
- Сохранение всех настроек View в пользовательских настройках
- Корректное вычисление центра групп для оси констрейна
- Поддержка фиксации оси к текущей позиции объекта при зажатии Shift

### Changed
- Ось констрейна теперь фиксируется к центру объекта/группы, а не к курсору
- Ось отображается в обе стороны от центра до краев видимой области
- Настройки View (Grid, Game Mode, Snap To Grid, Object Boundaries, Object Collisions) теперь сохраняются между сессиями
- Game Mode корректно восстанавливается при перезапуске редактора

### Fixed
- Исправлена отрисовка оси констрейна с учетом зума и панорамирования камеры
- Исправлено вычисление центра групп для более точного позиционирования оси
- Исправлено сохранение состояния Game Mode при перезапуске

## [3.9.0] - 2024-12-19

### Added
- Новая система поиска в OutlinerPanel с использованием унифицированного SearchUtils
- Контекстное меню для объектов в OutlinerPanel (OutlinerContextMenu)
- Логика выделения диапазона объектов (Shift+клик)
- Логика переключения единичных объектов (Ctrl+клик)
- Поддержка выделения по отфильтрованному списку при активном поиске
- Новый класс SearchUtils для унифицированного поиска в панелях
- Поддержка Logger.outliner для логирования операций OutlinerPanel

### Changed
- OutlinerPanel теперь использует общую систему поиска с LayersPanel
- Стиль переименования объектов приведен в соответствие с LayersPanel
- Позиционирование иконок типов объектов исправлено и выровнено
- reassignIdsDeep теперь создает строковые ID вместо числовых
- Улучшена индексация дублированных объектов в группах

### Fixed
- Исправлено контекстное меню, которое постоянно показывалось и не исчезало
- Исправлено накопление обработчиков событий при пересоздании контекстного меню
- Исправлена работа контекстного меню на дублированных объектах
- Исправлено позиционирование иконок типов объектов в OutlinerPanel
- Исправлено появление скролл-бара при активации переименования

## [3.8.8] - 2024-12-19

### Fixed
- Исправлены координаты дублируемых объектов в открытых группах - теперь дубликаты появляются точно в том же месте, что и оригиналы
- Исправлен расчет мировых координат для объектов внутри групп при дублировании
- Упрощена логика размещения дублированных объектов в режиме редактирования групп

## [3.8.7] - 2024-12-19

### Added
- Защита от добавления объектов на заблокированные слои через drag&drop

### Changed
- Ctrl+Click на слое теперь выбирает все объекты в слое вместо выбора слоёв
- Alt+Click+Drag теперь работает на любых объектах, не только выбранных

### Fixed
- Исправлена команда "Show All Layers" - объекты корректно отображаются после изменения видимости
- Исправлено дублирование с Alt+Click на невыбранных объектах

### Removed
- Удалена команда "Move Objects to Main Layer" из контекстного меню слоёв
- Удалена логика выбора слоёв (selectedLayers) и связанные методы
- Удалены пункты меню "Select All Layers" и "Deselect All"

## [3.8.6] - 2024-12-18

### Fixed
- Исправлена система версионирования
- Улучшена архитектура утилитарных классов
