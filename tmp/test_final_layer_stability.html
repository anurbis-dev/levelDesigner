<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Layer Stability Test</title>
</head>
<body>
    <h1>Final Layer Stability Test</h1>
    <div id="output"></div>

    <script type="module">
        import { Level } from '../src/models/Level.js';
        import { Asset } from '../src/models/Asset.js';

        const output = document.getElementById('output');

        function log(message) {
            console.log(message);
            output.innerHTML += `<div>${message}</div>`;
        }

        log('ðŸ§ª Final Layer Stability Test...');

        // Create level
        const level = new Level();

        // Get initial Main layer ID
        const initialMainLayerId = level.getMainLayerId();
        log(`Initial Main layer ID: ${initialMainLayerId}`);

        // Add multiple layers
        log('\nðŸ“‹ Adding layers...');
        level.addLayer('Background');
        level.addLayer('Middle');
        level.addLayer('Foreground');
        level.addLayer('UI');

        log('Layers after adding:');
        level.layers.forEach((layer, index) => {
            log(`  Position ${index}: ${layer.name} (ID: ${layer.id})`);
        });

        // Test 1: Main layer should still be first
        const mainLayerIdAfterAdding = level.getMainLayerId();
        log(`\nðŸ“‹ Test 1: Main layer position after adding`);
        log(`Main layer ID: ${mainLayerIdAfterAdding}`);
        log(`Still first: ${level.layers[0].id === mainLayerIdAfterAdding ? 'YES' : 'NO'}`);
        log(`Consistent: ${initialMainLayerId === mainLayerIdAfterAdding ? 'YES' : 'NO'}`);

        // Test 2: Add objects
        log('\nðŸ“‹ Test 2: Adding objects');
        const asset = new Asset({
            name: 'Test Asset',
            type: 'object',
            width: 32,
            height: 32,
            color: '#ff0000'
        });

        for (let i = 0; i < 5; i++) {
            const obj = asset.createInstance(i * 50, i * 50);
            level.addObject(obj);
            log(`  Object ${i + 1}: layerId=${obj.layerId} (${obj.layerId === mainLayerIdAfterAdding ? 'correct' : 'WRONG'})`);
        }

        // Test 3: Reorder layers
        log('\nðŸ“‹ Test 3: Reordering layers');

        // Create new order that moves Main to the middle
        const currentOrder = level.layers.map(l => l.id);
        const mainIndex = currentOrder.indexOf(mainLayerIdAfterAdding);

        // Move Main to position 2
        const newOrder = [...currentOrder];
        newOrder.splice(mainIndex, 1);
        newOrder.splice(2, 0, mainLayerIdAfterAdding);

        log(`Reordering: [${currentOrder.join(', ')}] -> [${newOrder.join(', ')}]`);
        level.reorderLayers(newOrder);

        log('Layers after reordering:');
        level.layers.forEach((layer, index) => {
            log(`  Position ${index}: ${layer.name} (ID: ${layer.id})`);
        });

        // Test 4: Verify Main layer is back to first position
        const mainLayerIdAfterReorder = level.getMainLayerId();
        log(`\nðŸ“‹ Test 4: Main layer after reorder`);
        log(`Main layer ID: ${mainLayerIdAfterReorder}`);
        log(`Back to first position: ${level.layers[0].id === mainLayerIdAfterReorder ? 'YES' : 'NO'}`);
        log(`Still consistent: ${initialMainLayerId === mainLayerIdAfterReorder ? 'YES' : 'NO'}`);

        // Test 5: Add more objects after reordering
        log('\nðŸ“‹ Test 5: Adding objects after reorder');
        for (let i = 5; i < 8; i++) {
            const obj = asset.createInstance(i * 50, i * 50);
            level.addObject(obj);
            log(`  Object ${i + 1}: layerId=${obj.layerId} (${obj.layerId === mainLayerIdAfterReorder ? 'correct' : 'WRONG'})`);
        }

        // Test 6: Check final state
        log('\nðŸ“‹ Test 6: Final verification');
        log('Final layers:');
        level.layers.forEach((layer, index) => {
            log(`  Position ${index}: ${layer.name} (ID: ${layer.id})`);
        });

        const finalMainLayerId = level.getMainLayerId();
        log(`Final Main layer ID: ${finalMainLayerId}`);
        log(`Consistent throughout: ${initialMainLayerId === finalMainLayerId ? 'YES' : 'NO'}`);
        log(`Main is first: ${level.layers[0].id === finalMainLayerId ? 'YES' : 'NO'}`);

        // Test 7: Object counts
        log('\nðŸ“‹ Test 7: Object counts by layer');
        level.layers.forEach(layer => {
            const count = level.getLayerObjectsCount(layer.id);
            log(`  ${layer.name}: ${count} objects`);
        });

        const totalObjects = level.objects.length;
        const mainLayerObjects = level.getLayerObjects(finalMainLayerId).length;
        log(`\nTotal objects: ${totalObjects}`);
        log(`Objects in Main layer: ${mainLayerObjects}`);
        log(`All objects in Main: ${totalObjects === mainLayerObjects ? 'YES' : 'NO'}`);

        log('\nðŸŽ‰ Final test completed!');
        log('âœ… Layer position stability confirmed!');
    </script>
</body>
</html>
