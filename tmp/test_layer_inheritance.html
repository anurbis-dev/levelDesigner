<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layer Inheritance Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #555;
            border-radius: 5px;
        }
        .test-pass {
            color: #4ade80;
        }
        .test-fail {
            color: #ef4444;
        }
        .test-info {
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <h1>Тест наследования Layer ID</h1>
    <div id="output"></div>

    <script type="module">
        import { Level } from '../src/models/Level.js';
        import { GameObject } from '../src/models/GameObject.js';
        import { Group } from '../src/models/Group.js';
        import { RenderOperations } from '../src/core/RenderOperations.js';

        const output = document.getElementById('output');
        function log(message, className = '') {
            const div = document.createElement('div');
            div.className = className;
            div.textContent = message;
            output.appendChild(div);
        }

        function testSection(title) {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `<h3>${title}</h3>`;
            output.appendChild(section);
            return section;
        }

        async function runTests() {
            log('=== ТЕСТ НАСЛЕДОВАНИЯ LAYERID ===', 'test-info');

            try {
                // Создаем тестовый уровень
                const level = new Level();
                log('Создан уровень', 'test-info');

                // Создаем дополнительные слои для тестирования
                const layer1 = level.addLayer('Test Layer 1');
                const layer2 = level.addLayer('Test Layer 2');
                log(`Созданы дополнительные слои: ${layer1.id}, ${layer2.id}`, 'test-info');

                // Получаем ID основного слоя
                const mainLayerId = level.getMainLayerId();
                log(`Основной слой: ${mainLayerId}`, 'test-info');

                // Создаем mock editor для RenderOperations
                const mockEditor = {
                    level: level,
                    effectiveLayerCache: new Map()
                };

                // Создаем RenderOperations для тестирования
                const renderOps = new RenderOperations();
                renderOps.editor = mockEditor;

                // Тест 1: Объект без layerId в группе с layerId
                const section1 = testSection('ТЕСТ 1: Объект без layerId в группе с layerId');
                const group1 = new Group({
                    name: 'TestGroup1',
                    x: 0,
                    y: 0,
                    layerId: layer1.id // Группа имеет определенный слой
                });

                const obj1 = new GameObject({
                    name: 'TestObject1',
                    x: 10,
                    y: 10,
                    layerId: null // Объект без layerId
                });

                group1.children.push(obj1);
                level.addObject(group1);

                log(`Группа layerId: ${group1.layerId}`, 'test-info');
                log(`Объект layerId: ${obj1.layerId}`, 'test-info');
                const effectiveLayerId1 = renderOps.getEffectiveLayerId(obj1);
                log(`Effective layerId объекта: ${effectiveLayerId1}`, 'test-info');
                log(`Ожидаемый результат: ${layer1.id}`, 'test-info');
                const test1Passed = effectiveLayerId1 === layer1.id;
                log(`Тест 1 прошел: ${test1Passed}`, test1Passed ? 'test-pass' : 'test-fail');

                // Тест 2: Объект с собственным layerId в группе с другим layerId
                const section2 = testSection('ТЕСТ 2: Объект с собственным layerId в группе с другим layerId');
                const group2 = new Group({
                    name: 'TestGroup2',
                    x: 50,
                    y: 50,
                    layerId: layer1.id // Группа имеет layer1
                });

                const obj2 = new GameObject({
                    name: 'TestObject2',
                    x: 60,
                    y: 60,
                    layerId: layer2.id // Объект имеет свой собственный layer2
                });

                group2.children.push(obj2);
                level.addObject(group2);

                log(`Группа layerId: ${group2.layerId}`, 'test-info');
                log(`Объект layerId: ${obj2.layerId}`, 'test-info');
                const effectiveLayerId2 = renderOps.getEffectiveLayerId(obj2);
                log(`Effective layerId объекта: ${effectiveLayerId2}`, 'test-info');
                log(`Ожидаемый результат: ${layer2.id} (объект использует свой собственный)`, 'test-info');
                const test2Passed = effectiveLayerId2 === layer2.id;
                log(`Тест 2 прошел: ${test2Passed}`, test2Passed ? 'test-pass' : 'test-fail');

                // Тест 3: Объект без layerId в группе без layerId (должен наследовать основной слой)
                const section3 = testSection('ТЕСТ 3: Объект без layerId в группе без layerId');
                const group3 = new Group({
                    name: 'TestGroup3',
                    x: 100,
                    y: 100,
                    layerId: null // Группа без layerId
                });

                const obj3 = new GameObject({
                    name: 'TestObject3',
                    x: 110,
                    y: 110,
                    layerId: null // Объект без layerId
                });

                group3.children.push(obj3);
                level.addObject(group3);

                log(`Группа layerId: ${group3.layerId}`, 'test-info');
                log(`Объект layerId: ${obj3.layerId}`, 'test-info');
                const effectiveLayerId3 = renderOps.getEffectiveLayerId(obj3);
                log(`Effective layerId объекта: ${effectiveLayerId3}`, 'test-info');
                log(`Ожидаемый результат: ${mainLayerId} (наследование от основного слоя)`, 'test-info');
                const test3Passed = effectiveLayerId3 === mainLayerId;
                log(`Тест 3 прошел: ${test3Passed}`, test3Passed ? 'test-pass' : 'test-fail');

                // Тест 4: Вложенные группы - наследование через цепочку
                const section4 = testSection('ТЕСТ 4: Вложенные группы - наследование через цепочку');
                const parentGroup = new Group({
                    name: 'ParentGroup',
                    x: 150,
                    y: 150,
                    layerId: layer2.id // Родительская группа имеет layer2
                });

                const childGroup = new Group({
                    name: 'ChildGroup',
                    x: 160,
                    y: 160,
                    layerId: null // Дочерняя группа без layerId
                });

                const nestedObj = new GameObject({
                    name: 'NestedObject',
                    x: 170,
                    y: 170,
                    layerId: null // Вложенный объект без layerId
                });

                childGroup.children.push(nestedObj);
                parentGroup.children.push(childGroup);
                level.addObject(parentGroup);

                log(`Родительская группа layerId: ${parentGroup.layerId}`, 'test-info');
                log(`Дочерняя группа layerId: ${childGroup.layerId}`, 'test-info');
                log(`Вложенный объект layerId: ${nestedObj.layerId}`, 'test-info');
                const effectiveLayerId4 = renderOps.getEffectiveLayerId(nestedObj);
                log(`Effective layerId вложенного объекта: ${effectiveLayerId4}`, 'test-info');
                log(`Ожидаемый результат: ${layer2.id} (наследование от родительской группы)`, 'test-info');
                const test4Passed = effectiveLayerId4 === layer2.id;
                log(`Тест 4 прошел: ${test4Passed}`, test4Passed ? 'test-pass' : 'test-fail');

                // Тест 5: Проверка метода Group.addChild
                const section5 = testSection('ТЕСТ 5: Проверка метода Group.addChild');
                const group5 = new Group({
                    name: 'TestGroup5',
                    x: 200,
                    y: 200,
                    layerId: layer1.id
                });

                const obj5 = new GameObject({
                    name: 'TestObject5',
                    x: 210,
                    y: 210,
                    layerId: null
                });

                // Используем метод addChild вместо прямого добавления
                group5.addChild(obj5);
                level.addObject(group5);

                log(`Группа layerId: ${group5.layerId}`, 'test-info');
                log(`Объект layerId (после addChild): ${obj5.layerId}`, 'test-info');
                const effectiveLayerId5 = renderOps.getEffectiveLayerId(obj5);
                log(`Effective layerId объекта: ${effectiveLayerId5}`, 'test-info');
                log(`Ожидаемый результат: ${layer1.id}`, 'test-info');
                const test5Passed = obj5.layerId === layer1.id && effectiveLayerId5 === layer1.id;
                log(`Тест 5 прошел: ${test5Passed}`, test5Passed ? 'test-pass' : 'test-fail');

                // Тест 6: Проверка добавления группы с детьми в другую группу
                const section6 = testSection('ТЕСТ 6: Добавление группы с детьми в другую группу');
                const parentGroup6 = new Group({
                    name: 'ParentGroup6',
                    x: 250,
                    y: 250,
                    layerId: layer2.id
                });

                const childGroup6 = new Group({
                    name: 'ChildGroup6',
                    x: 260,
                    y: 260,
                    layerId: null
                });

                const nestedObj6 = new GameObject({
                    name: 'NestedObject6',
                    x: 270,
                    y: 270,
                    layerId: null
                });

                childGroup6.addChild(nestedObj6);

                // Теперь добавляем childGroup6 в parentGroup6
                parentGroup6.addChild(childGroup6);
                level.addObject(parentGroup6);

                log(`Родительская группа layerId: ${parentGroup6.layerId}`, 'test-info');
                log(`Дочерняя группа layerId (после addChild): ${childGroup6.layerId}`, 'test-info');
                log(`Вложенный объект layerId (после addChild): ${nestedObj6.layerId}`, 'test-info');

                const effectiveLayerId6 = renderOps.getEffectiveLayerId(nestedObj6);
                log(`Effective layerId вложенного объекта: ${effectiveLayerId6}`, 'test-info');
                log(`Ожидаемый результат: ${layer2.id}`, 'test-info');
                const test6Passed = childGroup6.layerId === layer2.id && nestedObj6.layerId === layer2.id && effectiveLayerId6 === layer2.id;
                log(`Тест 6 прошел: ${test6Passed}`, test6Passed ? 'test-pass' : 'test-fail');

                // Тест 7: Проверка на уровне всего уровня
                const section7 = testSection('ТЕСТ 7: Проверка всех объектов уровня');
                const allObjects = level.getAllObjects();
                log(`Всего объектов в уровне: ${allObjects.length}`, 'test-info');

                let inheritanceTestsPassed = 0;
                let totalInheritanceTests = 0;

                allObjects.forEach(obj => {
                    if (obj.type !== 'group') { // Проверяем только объекты, не группы
                        totalInheritanceTests++;
                        const effectiveLayerId = renderOps.getEffectiveLayerId(obj);
                        const expectedLayerId = obj.layerId ||
                            (obj.parent && obj.parent.layerId) ||
                            mainLayerId;

                        log(`Объект ${obj.name}: layerId=${obj.layerId}, effective=${effectiveLayerId}, expected=${expectedLayerId}`, 'test-info');

                        if (effectiveLayerId === expectedLayerId) {
                            inheritanceTestsPassed++;
                        }
                    }
                });

                log(`Наследование layerId работает корректно для ${inheritanceTestsPassed}/${totalInheritanceTests} объектов`,
                    inheritanceTestsPassed === totalInheritanceTests ? 'test-pass' : 'test-fail');

                log('=== ТЕСТ НАСЛЕДОВАНИЯ LAYERID ЗАВЕРШЕН ===', 'test-info');

            } catch (error) {
                log(`Ошибка выполнения теста: ${error.message}`, 'test-fail');
                console.error(error);
            }
        }

        // Запускаем тесты
        runTests();
    </script>
</body>
</html>
