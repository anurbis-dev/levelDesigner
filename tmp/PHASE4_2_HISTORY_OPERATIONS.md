# ‚úÖ –§–∞–∑–∞ 4.2 –ó–ê–í–ï–†–®–ï–ù–ê: –ú–æ–¥—É–ª—å HistoryOperations (v3.40.0)

## üìÖ –î–∞—Ç–∞: 2025-10-05
## üéØ –°—Ç–∞—Ç—É—Å: –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –í–´–ü–û–õ–ù–ï–ù

---

## üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `HistoryOperations`
**–§–∞–π–ª**: `src/core/HistoryOperations.js` (144 —Å—Ç—Ä–æ–∫–∏)

```javascript
export class HistoryOperations extends BaseModule {
    undo()                          // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ undo
    redo()                          // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ redo
    restoreObjectsFromHistory()     // –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
    rebuildAllIndices()             // –ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
    restoreGroupEditMode()          // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –≥—Ä—É–ø–ø—ã
    recalculateGroupBounds()        // –ü–µ—Ä–µ—Å—á–µ—Ç –≥—Ä–∞–Ω–∏—Ü
    invalidateCachesAfterRestore()  // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–µ–π
    restoreSelection()              // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    finalizeHistoryRestore()        // –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏
    destroy()                       // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
}
```

### –û–±–Ω–æ–≤–ª–µ–Ω `LevelEditor.js`

**–ë–´–õ–û** (2693 —Å—Ç—Ä–æ–∫–∏):
```javascript
undo() {
    const previousState = this.historyManager.undo();
    if (!previousState) return;
    
    this._restoreObjectsFromHistory(previousState.objects);
    this._rebuildAllIndices();
    // ... –µ—â–µ 110 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∏–∫–∏
}

redo() {
    const nextState = this.historyManager.redo();
    if (!nextState) return;
    
    // ... –µ—â–µ 110 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä—É—é—â–µ–π—Å—è –ª–æ–≥–∏–∫–∏
}

// + 6 –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ (~120 —Å—Ç—Ä–æ–∫)
```

**–°–¢–ê–õ–û** (2415 —Å—Ç—Ä–æ–∫):
```javascript
// –í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
this.historyOperations = new HistoryOperations(this);
this.lifecycle.register('historyOperations', this.historyOperations, { priority: 9 });

// –ú–µ—Ç–æ–¥—ã —Å—Ç–∞–ª–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ –¥–µ–ª–µ–≥–∞—Ç–∞–º–∏
undo() {
    this.historyOperations.undo();
}

redo() {
    this.historyOperations.redo();
}
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π

### –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤:
- **LevelEditor.js**: 2693 ‚Üí 2415 —Å—Ç—Ä–æ–∫ (**-278 —Å—Ç—Ä–æ–∫, -10.3%**)
- **HistoryOperations.js**: +144 —Å—Ç—Ä–æ–∫–∏ (–Ω–æ–≤—ã–π –º–æ–¥—É–ª—å)
- **–ß–∏—Å—Ç–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ**: -134 —Å—Ç—Ä–æ–∫–∏ (-5%)

### –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å:
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**: –ò—Å—Ç–æ—Ä–∏—è —Ç–µ–ø–µ—Ä—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–æ–¥—É–ª–µ
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: HistoryOperations –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–¥–µ–ª—å–Ω–æ

### –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å:
- **LevelEditor**: +10% —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ (–º–µ–Ω—å—à–µ –∫–æ–¥–∞, —á–µ—Ç—á–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- **HistoryOperations**: –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. Separation of Concerns
- –ò—Å—Ç–æ—Ä–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º –º–æ–¥—É–ª–µ–º
- LevelEditor –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª–µ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –¥–µ–ª–∞–µ—Ç –æ–¥–Ω—É –≤–µ—â—å

### 2. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- HistoryOperations –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- –ú–µ—Ç–æ–¥—ã –ø—É–±–ª–∏—á–Ω—ã–µ, –Ω–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ
- –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### 3. Maintainability
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–æ–≥–∏–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- –ù–µ –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤ –æ–≥—Ä–æ–º–Ω–æ–º LevelEditor
- –ü—Ä–æ—â–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, history branching)

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å HistoryOperations –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –ú–æ–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ª–µ–≥–∫–æ —Å–æ–∑–¥–∞—é—Ç—Å—è
- –ö–∞–∂–¥—ã–π –º–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Lifecycle
```javascript
this.lifecycle.register('historyOperations', this.historyOperations, { priority: 9 });
```
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 9 (–ø–æ—Å–ª–µ eventHandlers —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º 10)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ destroy()

### –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç BaseModule
```javascript
export class HistoryOperations extends BaseModule
```
- –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º helper-–º–µ—Ç–æ–¥–∞–º –∏–∑ BaseModule
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏ (ObjectOperations, GroupOperations, etc.)

### –ú–µ—Ç–æ–¥—ã —Ç–µ–ø–µ—Ä—å –ø—É–±–ª–∏—á–Ω—ã–µ
- –ë—ã–ª–æ: `_restoreObjectsFromHistory()` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
- –°—Ç–∞–ª–æ: `restoreObjectsFromHistory()` (–ø—É–±–ª–∏—á–Ω—ã–π)
- –õ—É—á—à–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:
- ‚úÖ –†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ Undo/Redo —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞
- ‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- ‚úÖ –ú–æ–¥—É–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ lifecycle

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. ‚úÖ ~~HistoryOperations~~ DONE
2. ‚è≥ LayerOperations - —Ä–∞–∑–±–∏—Ç—å assignSelectedObjectsToLayer() (~250 —Å—Ç—Ä–æ–∫)
3. ‚è≥ CacheManager - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
4. ‚è≥ –†–∞–∑–±–∏—Ç—å applyConfiguration() (~80 —Å—Ç—Ä–æ–∫)

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –í–´–ü–û–õ–ù–ï–ù
**–í–µ—Ä—Å–∏—è**: 3.39.0 ‚Üí 3.40.0
**Breaking changes**: –ù–µ—Ç (–ø—É–±–ª–∏—á–Ω—ã–π API –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è)
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–π–¥–µ–Ω–æ
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∫–æ–º–º–∏—Ç—É**: ‚úÖ –î–∞
