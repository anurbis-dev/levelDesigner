<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Group Edit Undo/Redo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        .step {
            margin: 10px 0;
            padding: 8px;
            background: #f9f9f9;
            border-left: 4px solid #007acc;
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
        .expected {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .issue {
            background: #ffebee;
            border: 1px solid #f44336;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç: Undo/Redo –¥–ª—è –≥—Ä—É–ø–ø –≤–Ω—É—Ç—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –≥—Ä—É–ø–ø—ã</h1>

    <div class="test-section">
        <h2 class="test-title">–°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>

        <div class="step">
            <strong>–®–∞–≥ 1:</strong> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏
        </div>

        <div class="step">
            <strong>–®–∞–≥ 2:</strong> –û—Ç–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –≥—Ä—É–ø–ø–µ)
        </div>

        <div class="step">
            <strong>–®–∞–≥ 3:</strong> –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –∏–∑–º–µ–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç)
        </div>

        <div class="step">
            <strong>–®–∞–≥ 4:</strong> –í—ã–ø–æ–ª–Ω–∏—Ç—å Undo (Ctrl+Z)
        </div>

        <div class="step">
            <strong>–®–∞–≥ 5:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –æ—Å—Ç–∞—é—Ç—Å—è selectable (–º–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å –∏–ª–∏ –≤—ã–¥–µ–ª–∏—Ç—å —Ä–∞–º–∫–æ–π)
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏</h2>

        <h3>–í Group Edit Mode:</h3>
        <ul>
            <li>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è <code>computeSelectableSet()</code> –≤–º–µ—Å—Ç–æ viewport-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</li>
            <li>–ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –≤–∫–ª—é—á–∞—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ</li>
            <li>–ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ <code>isObjectSelectable()</code></li>
            <li><code>isObjectSelectable()</code> –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–ª–æ—è —á–µ—Ä–µ–∑ <code>getEffectiveLayerId()</code></li>
        </ul>

        <h3>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ undo/redo:</h3>
        <div class="code">
// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏
this.level.objects = previousState.objects.map(objData => {
    if (objData.type === 'group') {
        return Group.fromJSON(objData); // –ü—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ layerId
    } else {
        return GameObject.fromJSON(objData);
    }
});

// –ü–µ—Ä–µ—Å—á–µ—Ç –≤—Å–µ—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –∫–µ—à–µ–π
this.level.buildObjectsIndex();
this.level.rebuildLayerCountsCache();
this.renderOperations.buildSpatialIndex(); // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –≥—Ä–∞–Ω–∏—Ü –≥—Ä—É–ø–ø

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ group edit mode —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ñ–ª–∞–≥–æ–≤ _isEditing –∏ originalChildren
this.updateGroupEditModeAfterRestore(previousState.selection);

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –≥—Ä–∞–Ω–∏—Ü –≥—Ä—É–ø–ø—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ frozenBounds
// –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–º–∫–∏ –≥—Ä—É–ø–ø—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ undo/redo

// –£–º–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –∫–µ—à–µ–π (invalidateAll: true)
this.smartCacheInvalidation({
    objectIds: allRestoredObjectIds,
    invalidateAll: true,
    reason: 'undo_restore'
});
        </div>

        <div class="expected">
            ‚úÖ –û–±—ä–µ–∫—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–∞–∫ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–ª–∞—Å—Å–æ–≤<br>
            ‚úÖ –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ layerId –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏<br>
            ‚úÖ –ò–Ω–¥–µ–∫—Å –æ–±—ä–µ–∫—Ç–æ–≤ –∞–∫—Ç—É–∞–ª–µ–Ω<br>
            ‚úÖ Spatial index –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü –≥—Ä—É–ø–ø<br>
            ‚úÖ Group edit mode —Å—Å—ã–ª–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π _isEditing —Ñ–ª–∞–≥–æ–≤<br>
            ‚úÖ –ì—Ä–∞–Ω–∏—Ü—ã –≥—Ä—É–ø–ø—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è frozenBounds<br>
            ‚úÖ Selection –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –≤ group edit mode<br>
            ‚úÖ –ì—Ä—É–ø–ø–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ—Ç–∫—Ä—ã—Ç–∏—é/–∑–∞–∫—Ä—ã—Ç–∏—é –≥—Ä—É–ø–ø—ã<br>
            ‚úÖ –£–º–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –∫–µ—à–µ–π (–Ω–µ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞)<br>
            ‚úÖ –ì—Ä—É–ø–ø—ã —Å—Ä–∞–∑—É selectable –∏ —Ä–∞–º–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ—Å–ª–µ undo/redo
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π</h2>

        <div class="step">
            <strong>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏:</strong>
            <div class="code">
// –ü–æ—Å–ª–µ undo –≤ group edit mode
console.log('Selectable set size:', editor.objectOperations.computeSelectableSet().size);
console.log('Group edit mode active:', editor.objectOperations.isInGroupEditMode());
console.log('Active group exists:', editor.objectOperations.getActiveGroup() !== null);
console.log('Group edit mode state:', editor.stateManager.get('groupEditMode'));
console.log('Has nested groups:', editor.level.getAllObjects().some(o => o.type === 'group'));
            </div>
        </div>

        <div class="step">
            <strong>–í–∏–∑—É–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:</strong>
            <ul>
                <li>–ì—Ä—É–ø–ø—ã –≤—ã–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ group edit mode</li>
                <li>–†–∞–º–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø</li>
                <li>Redo —Ç–∞–∫–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</li>
            </ul>
        </div>
    </div>

    <div class="issue">
        <strong>–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±—ä–µ–∫—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞–º–∏ –∏ layerId.
    </div>
</body>
</html>
