<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Color Fixes Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1f2937; color: white; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #374151; border-radius: 8px; }
        .test-button { padding: 10px 20px; margin: 5px; background: #3b82f6; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .test-button:hover { background: #2563eb; }
        .result { margin: 10px 0; padding: 10px; background: #111827; border-radius: 4px; }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
        .warning { border-left: 4px solid #f59e0b; }
        pre { background: #000; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .color-preview { width: 50px; height: 30px; border: 1px solid #666; display: inline-block; margin-left: 10px; }
    </style>
</head>
<body>
    <h1>Grid Color Fixes Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Color Conversion Functions</h2>
        <p>Test rgba to hex conversion and vice versa</p>
        <button class="test-button" onclick="testColorConversion()">Test Color Conversion</button>
        <div id="conversion-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Simulate Settings Display</h2>
        <p>Test how colors are displayed in settings panel</p>
        <button class="test-button" onclick="testSettingsDisplay()">Test Settings Display</button>
        <div id="display-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Simulate Reset to Defaults</h2>
        <p>Test reset functionality with color synchronization</p>
        <button class="test-button" onclick="testResetToDefaults()">Test Reset to Defaults</button>
        <div id="reset-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Full Save/Load Cycle</h2>
        <p>Test complete save and load cycle with color fixes</p>
        <button class="test-button" onclick="testFullCycle()">Test Full Cycle</button>
        <div id="cycle-result" class="result"></div>
    </div>

    <script>
        // Simulate ConfigManager
        class TestConfigManager {
            constructor() {
                this.configs = {
                    grid: {
                        size: 32,
                        color: '#ffffff',
                        opacity: 0.1,
                        thickness: 1,
                        subdivisions: 4,
                        subdivColor: '#666666',
                        subdivThickness: 0.5,
                        showGrid: true
                    }
                };
            }
            
            get(key) {
                const keys = key.split('.');
                let value = this.configs;
                for (const k of keys) {
                    value = value?.[k];
                }
                return value;
            }
            
            set(key, value) {
                const keys = key.split('.');
                let obj = this.configs;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!obj[keys[i]]) obj[keys[i]] = {};
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            }
            
            reset() {
                this.configs.grid = {
                    size: 32,
                    color: '#ffffff',
                    opacity: 0.1,
                    thickness: 1,
                    subdivisions: 4,
                    subdivColor: '#666666',
                    subdivThickness: 0.5,
                    showGrid: true
                };
            }
        }

        // Simulate StateManager
        class TestStateManager {
            constructor() {
                this.state = {
                    canvas: {
                        gridSize: 32,
                        gridColor: 'rgba(255, 255, 255, 0.1)',
                        gridThickness: 1,
                        gridOpacity: 0.1,
                        gridSubdivisions: 4,
                        gridSubdivColor: 'rgba(102, 102, 102, 0.1)',
                        gridSubdivThickness: 0.5
                    }
                };
            }
            
            get(key) {
                const keys = key.split('.');
                let value = this.state;
                for (const k of keys) {
                    value = value?.[k];
                }
                return value;
            }
            
            set(key, value) {
                const keys = key.split('.');
                let obj = this.state;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!obj[keys[i]]) obj[keys[i]] = {};
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            }
        }

        // Simulate GridSettings with color conversion
        class TestGridSettings {
            constructor(configManager) {
                this.configManager = configManager;
            }
            
            rgbaToHex(rgbaColor) {
                if (!rgbaColor || !rgbaColor.startsWith('rgba')) {
                    return rgbaColor || '#ffffff';
                }
                
                const match = rgbaColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (!match) {
                    return '#ffffff';
                }
                
                const r = parseInt(match[1]);
                const g = parseInt(match[2]);
                const b = parseInt(match[3]);
                
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            
            syncAllGridSettingsToState() {
                const gridSize = this.configManager.get('grid.size') ?? 32;
                const gridColor = this.configManager.get('grid.color') ?? '#ffffff';
                const gridThickness = this.configManager.get('grid.thickness') ?? 1;
                const gridOpacity = this.configManager.get('grid.opacity') ?? 0.1;
                const gridSubdivisions = this.configManager.get('grid.subdivisions') ?? 4;
                const gridSubdivColor = this.configManager.get('grid.subdivColor') ?? '#666666';
                const gridSubdivThickness = this.configManager.get('grid.subdivThickness') ?? 0.5;

                // Convert and set each parameter
                window.stateManager.set('canvas.gridSize', gridSize);

                // Convert main grid color
                let colorValue = gridColor;
                if (gridColor.startsWith('#')) {
                    const r = parseInt(gridColor.slice(1, 3), 16);
                    const g = parseInt(gridColor.slice(3, 5), 16);
                    const b = parseInt(gridColor.slice(5, 7), 16);
                    colorValue = `rgba(${r}, ${g}, ${b}, ${gridOpacity})`;
                }
                window.stateManager.set('canvas.gridColor', colorValue);

                window.stateManager.set('canvas.gridThickness', gridThickness);
                window.stateManager.set('canvas.gridOpacity', gridOpacity);
                window.stateManager.set('canvas.gridSubdivisions', gridSubdivisions);

                // Convert subdivision color
                let subdivColorValue = gridSubdivColor;
                if (gridSubdivColor.startsWith('#')) {
                    const r = parseInt(gridSubdivColor.slice(1, 3), 16);
                    const g = parseInt(gridSubdivColor.slice(3, 5), 16);
                    const b = parseInt(gridSubdivColor.slice(5, 7), 16);
                    subdivColorValue = `rgba(${r}, ${g}, ${b}, ${gridOpacity})`;
                }
                window.stateManager.set('canvas.gridSubdivColor', subdivColorValue);

                window.stateManager.set('canvas.gridSubdivThickness', gridSubdivThickness);
            }
        }

        // Simulate SettingsPanel with color conversion
        class TestSettingsPanel {
            constructor(configManager, stateManager, gridSettings) {
                this.configManager = configManager;
                this.stateManager = stateManager;
                this.gridSettings = gridSettings;
            }
            
            rgbaToHex(rgbaColor) {
                if (!rgbaColor || !rgbaColor.startsWith('rgba')) {
                    return rgbaColor || '#ffffff';
                }
                
                const match = rgbaColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (!match) {
                    return '#ffffff';
                }
                
                const r = parseInt(match[1]);
                const g = parseInt(match[2]);
                const b = parseInt(match[3]);
                
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            
            saveSettings() {
                // Simulate saving from StateManager to ConfigManager
                const gridSize = this.stateManager.get('canvas.gridSize');
                const gridColor = this.stateManager.get('canvas.gridColor');
                const gridThickness = this.stateManager.get('canvas.gridThickness');
                const gridOpacity = this.stateManager.get('canvas.gridOpacity');
                const gridSubdivisions = this.stateManager.get('canvas.gridSubdivisions');
                const gridSubdivColor = this.stateManager.get('canvas.gridSubdivColor');
                const gridSubdivThickness = this.stateManager.get('canvas.gridSubdivThickness');

                if (gridSize !== undefined) this.configManager.set('grid.size', gridSize);
                if (gridColor !== undefined) {
                    // Convert rgba color to hex for storage
                    const hexColor = this.rgbaToHex(gridColor);
                    this.configManager.set('grid.color', hexColor);
                }
                if (gridThickness !== undefined) this.configManager.set('grid.thickness', gridThickness);
                if (gridOpacity !== undefined) this.configManager.set('grid.opacity', gridOpacity);
                if (gridSubdivisions !== undefined) this.configManager.set('grid.subdivisions', gridSubdivisions);
                if (gridSubdivColor !== undefined) {
                    // Convert rgba color to hex for storage
                    const hexSubdivColor = this.rgbaToHex(gridSubdivColor);
                    this.configManager.set('grid.subdivColor', hexSubdivColor);
                }
                if (gridSubdivThickness !== undefined) this.configManager.set('grid.subdivThickness', gridSubdivThickness);
            }
            
            resetSettings() {
                this.configManager.reset();
                // Sync grid settings after reset
                this.gridSettings.syncAllGridSettingsToState();
            }
        }

        // Initialize test components
        window.configManager = new TestConfigManager();
        window.stateManager = new TestStateManager();
        window.gridSettings = new TestGridSettings(window.configManager);
        window.settingsPanel = new TestSettingsPanel(window.configManager, window.stateManager, window.gridSettings);

        function testColorConversion() {
            const resultDiv = document.getElementById('conversion-result');
            
            const testCases = [
                { rgba: 'rgba(255, 255, 255, 0.1)', expected: '#ffffff' },
                { rgba: 'rgba(102, 102, 102, 0.1)', expected: '#666666' },
                { rgba: 'rgba(255, 0, 0, 0.5)', expected: '#ff0000' },
                { rgba: 'rgba(0, 255, 0, 0.3)', expected: '#00ff00' },
                { rgba: 'rgba(0, 0, 255, 0.8)', expected: '#0000ff' },
                { rgba: '#ffffff', expected: '#ffffff' },
                { rgba: null, expected: '#ffffff' }
            ];
            
            let allPassed = true;
            const results = [];
            
            testCases.forEach((testCase, index) => {
                const result = window.gridSettings.rgbaToHex(testCase.rgba);
                const passed = result === testCase.expected;
                if (!passed) allPassed = false;
                
                results.push(`
                    <div style="margin: 5px 0; padding: 5px; background: ${passed ? '#10b98120' : '#ef444420'}; border-radius: 4px;">
                        <strong>Test ${index + 1}:</strong> ${testCase.rgba} → ${result} 
                        <span style="color: ${passed ? '#10b981' : '#ef4444'}">${passed ? '✓' : '✗'}</span>
                        <div class="color-preview" style="background-color: ${result};"></div>
                    </div>
                `);
            });
            
            resultDiv.innerHTML = `
                <div class="${allPassed ? 'success' : 'error'}">
                    ${allPassed ? '✅ All color conversions passed!' : '❌ Some color conversions failed!'}
                </div>
                ${results.join('')}
            `;
        }

        function testSettingsDisplay() {
            const resultDiv = document.getElementById('display-result');
            
            // Simulate StateManager with rgba colors
            window.stateManager.set('canvas.gridColor', 'rgba(255, 0, 0, 0.3)');
            window.stateManager.set('canvas.gridSubdivColor', 'rgba(0, 255, 0, 0.3)');
            
            // Simulate saving settings (StateManager → ConfigManager)
            window.settingsPanel.saveSettings();
            
            // Check what's stored in ConfigManager
            const storedGridColor = window.configManager.get('grid.color');
            const storedSubdivColor = window.configManager.get('grid.subdivColor');
            
            // Simulate displaying in UI (ConfigManager → UI)
            const displayGridColor = window.gridSettings.rgbaToHex(storedGridColor);
            const displaySubdivColor = window.gridSettings.rgbaToHex(storedSubdivColor);
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h3>StateManager (rgba format):</h3>
                    <p>Grid Color: <span style="color: rgba(255, 0, 0, 0.3);">rgba(255, 0, 0, 0.3)</span></p>
                    <p>Subdiv Color: <span style="color: rgba(0, 255, 0, 0.3);">rgba(0, 255, 0, 0.3)</span></p>
                </div>
                <div class="info">
                    <h3>ConfigManager (hex format):</h3>
                    <p>Grid Color: <span style="color: ${storedGridColor};">${storedGridColor}</span> <div class="color-preview" style="background-color: ${storedGridColor};"></div></p>
                    <p>Subdiv Color: <span style="color: ${storedSubdivColor};">${storedSubdivColor}</span> <div class="color-preview" style="background-color: ${storedSubdivColor};"></div></p>
                </div>
                <div class="info">
                    <h3>UI Display (converted back):</h3>
                    <p>Grid Color: <span style="color: ${displayGridColor};">${displayGridColor}</span> <div class="color-preview" style="background-color: ${displayGridColor};"></div></p>
                    <p>Subdiv Color: <span style="color: ${displaySubdivColor};">${displaySubdivColor}</span> <div class="color-preview" style="background-color: ${displaySubdivColor};"></div></p>
                </div>
            `;
        }

        function testResetToDefaults() {
            const resultDiv = document.getElementById('reset-result');
            
            // Set some custom values first
            window.stateManager.set('canvas.gridSize', 64);
            window.stateManager.set('canvas.gridColor', 'rgba(255, 0, 0, 0.5)');
            window.stateManager.set('canvas.gridThickness', 2);
            window.stateManager.set('canvas.gridOpacity', 0.5);
            window.stateManager.set('canvas.gridSubdivisions', 8);
            window.stateManager.set('canvas.gridSubdivColor', 'rgba(0, 255, 0, 0.5)');
            window.stateManager.set('canvas.gridSubdivThickness', 1.5);
            
            const beforeReset = { ...window.stateManager.state.canvas };
            
            // Reset to defaults
            window.settingsPanel.resetSettings();
            
            const afterReset = { ...window.stateManager.state.canvas };
            const configAfterReset = { ...window.configManager.configs.grid };
            
            const isReset = 
                afterReset.gridSize === 32 &&
                afterReset.gridColor === 'rgba(255, 255, 255, 0.1)' &&
                afterReset.gridThickness === 1 &&
                afterReset.gridOpacity === 0.1 &&
                afterReset.gridSubdivisions === 4 &&
                afterReset.gridSubdivColor === 'rgba(102, 102, 102, 0.1)' &&
                afterReset.gridSubdivThickness === 0.5;
            
            resultDiv.innerHTML = `
                <div class="${isReset ? 'success' : 'error'}">
                    ${isReset ? '✅ Reset to defaults worked correctly!' : '❌ Reset to defaults failed!'}
                </div>
                <div class="info">
                    <h3>Before Reset:</h3>
                    <pre>${JSON.stringify(beforeReset, null, 2)}</pre>
                </div>
                <div class="info">
                    <h3>After Reset (StateManager):</h3>
                    <pre>${JSON.stringify(afterReset, null, 2)}</pre>
                </div>
                <div class="info">
                    <h3>After Reset (ConfigManager):</h3>
                    <pre>${JSON.stringify(configAfterReset, null, 2)}</pre>
                </div>
            `;
        }

        function testFullCycle() {
            const resultDiv = document.getElementById('cycle-result');
            
            // Step 1: Set custom values in StateManager
            window.stateManager.set('canvas.gridSize', 48);
            window.stateManager.set('canvas.gridColor', 'rgba(255, 128, 0, 0.4)');
            window.stateManager.set('canvas.gridThickness', 1.5);
            window.stateManager.set('canvas.gridOpacity', 0.4);
            window.stateManager.set('canvas.gridSubdivisions', 6);
            window.stateManager.set('canvas.gridSubdivColor', 'rgba(128, 0, 255, 0.4)');
            window.stateManager.set('canvas.gridSubdivThickness', 0.8);
            
            const step1 = { ...window.stateManager.state.canvas };
            
            // Step 2: Save settings (StateManager → ConfigManager)
            window.settingsPanel.saveSettings();
            const step2 = { ...window.configManager.configs.grid };
            
            // Step 3: Reset StateManager and reload from ConfigManager
            window.stateManager = new TestStateManager();
            window.gridSettings.syncAllGridSettingsToState();
            const step3 = { ...window.stateManager.state.canvas };
            
            // Check if values are preserved
            const isPreserved = 
                step3.gridSize === 48 &&
                step3.gridColor === 'rgba(255, 128, 0, 0.4)' &&
                step3.gridThickness === 1.5 &&
                step3.gridOpacity === 0.4 &&
                step3.gridSubdivisions === 6 &&
                step3.gridSubdivColor === 'rgba(128, 0, 255, 0.4)' &&
                step3.gridSubdivThickness === 0.8;
            
            resultDiv.innerHTML = `
                <div class="${isPreserved ? 'success' : 'error'}">
                    ${isPreserved ? '✅ Full cycle worked correctly!' : '❌ Full cycle failed!'}
                </div>
                <div class="info">
                    <h3>Step 1 - Initial StateManager:</h3>
                    <pre>${JSON.stringify(step1, null, 2)}</pre>
                </div>
                <div class="info">
                    <h3>Step 2 - Saved to ConfigManager:</h3>
                    <pre>${JSON.stringify(step2, null, 2)}</pre>
                </div>
                <div class="info">
                    <h3>Step 3 - Reloaded to StateManager:</h3>
                    <pre>${JSON.stringify(step3, null, 2)}</pre>
                </div>
            `;
        }
    </script>
</body>
</html>
