<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layer Position Stability Test</title>
</head>
<body>
    <h1>Layer Position Stability Test</h1>
    <div id="output"></div>

    <script type="module">
        import { Level } from '../src/models/Level.js';
        import { Asset } from '../src/models/Asset.js';

        const output = document.getElementById('output');

        function log(message) {
            console.log(message);
            output.innerHTML += `<div>${message}</div>`;
        }

        log('ðŸ§ª Testing layer position stability...');

        // Create level with default layers
        const level = new Level();

        log('\nðŸ“‹ Initial layer state:');
        const initialMainLayerId = level.getMainLayerId();
        log(`Main layer ID: ${initialMainLayerId}`);

        level.layers.forEach((layer, index) => {
            log(`  Position ${index}: ${layer.name} (ID: ${layer.id})`);
        });

        // Add more layers
        log('\nðŸ”„ Adding more layers...');
        const layer1 = level.addLayer('Background');
        const layer2 = level.addLayer('Foreground');
        const layer3 = level.addLayer('UI Elements');

        log('Layers after adding:');
        level.layers.forEach((layer, index) => {
            log(`  Position ${index}: ${layer.name} (ID: ${layer.id})`);
        });

        // Test 1: Check that Main layer ID is still the same
        const mainLayerIdAfterAdding = level.getMainLayerId();
        log(`\nðŸ“‹ Test 1: Main layer ID consistency`);
        log(`Initial Main layer ID: ${initialMainLayerId}`);
        log(`After adding layers: ${mainLayerIdAfterAdding}`);
        log(`Consistent: ${initialMainLayerId === mainLayerIdAfterAdding ? 'YES' : 'NO'}`);

        // Test 2: Add object and check its layer assignment
        log('\nðŸ“‹ Test 2: Object layer assignment');
        const asset = new Asset({
            name: 'Test Object',
            type: 'object',
            width: 32,
            height: 32,
            color: '#ff0000'
        });

        const obj1 = asset.createInstance(0, 0);
        level.addObject(obj1);
        log(`Object 1 layerId: ${obj1.layerId}`);
        log(`Assigned to Main layer: ${obj1.layerId === mainLayerIdAfterAdding ? 'YES' : 'NO'}`);

        // Test 3: Reorder layers multiple times
        log('\nðŸ“‹ Test 3: Layer reordering effects');

        // First reorder: move Main to the end
        let layerIds = level.layers.map(l => l.id);
        const mainIndex = layerIds.indexOf(mainLayerIdAfterAdding);
        layerIds.splice(mainIndex, 1);
        layerIds.push(mainLayerIdAfterAdding);

        log('Reordering 1: Moving Main to the end');
        level.reorderLayers(layerIds);

        log('Layers after reorder 1:');
        level.layers.forEach((layer, index) => {
            log(`  Position ${index}: ${layer.name} (ID: ${layer.id})`);
        });

        const mainLayerIdAfterReorder1 = level.getMainLayerId();
        log(`Main layer ID after reorder 1: ${mainLayerIdAfterReorder1}`);
        log(`Still consistent: ${initialMainLayerId === mainLayerIdAfterReorder1 ? 'YES' : 'NO'}`);

        // Test 4: Add another object after reordering
        const obj2 = asset.createInstance(100, 100);
        level.addObject(obj2);
        log(`\nObject 2 after reorder layerId: ${obj2.layerId}`);
        log(`Assigned to Main layer: ${obj2.layerId === mainLayerIdAfterReorder1 ? 'YES' : 'NO'}`);

        // Second reorder: shuffle layers
        layerIds = level.layers.map(l => l.id);
        // Move first layer to position 2
        const temp = layerIds[0];
        layerIds[0] = layerIds[1];
        layerIds[1] = layerIds[2];
        layerIds[2] = temp;

        log('\nReordering 2: Shuffling layers');
        level.reorderLayers(layerIds);

        log('Layers after reorder 2:');
        level.layers.forEach((layer, index) => {
            log(`  Position ${index}: ${layer.name} (ID: ${layer.id})`);
        });

        const mainLayerIdAfterReorder2 = level.getMainLayerId();
        log(`Main layer ID after reorder 2: ${mainLayerIdAfterReorder2}`);
        log(`Still consistent: ${initialMainLayerId === mainLayerIdAfterReorder2 ? 'YES' : 'NO'}`);

        // Test 5: Add object after second reordering
        const obj3 = asset.createInstance(200, 200);
        level.addObject(obj3);
        log(`\nObject 3 after shuffle layerId: ${obj3.layerId}`);
        log(`Assigned to Main layer: ${obj3.layerId === mainLayerIdAfterReorder2 ? 'YES' : 'NO'}`);

        // Test 6: Verify Main layer is still the first one
        const finalMainLayer = level.layers[0];
        log(`\nðŸ“‹ Final verification:`);
        log(`First layer name: ${finalMainLayer.name}`);
        log(`First layer ID: ${finalMainLayer.id}`);
        log(`Expected Main ID: ${initialMainLayerId}`);
        log(`Main layer is first: ${finalMainLayer.id === initialMainLayerId ? 'YES' : 'NO'}`);

        // Test 7: Check object counts
        log(`\nðŸ“‹ Object counts by layer:`);
        level.layers.forEach(layer => {
            const count = level.getLayerObjectsCount(layer.id);
            log(`  ${layer.name} (ID: ${layer.id}): ${count} objects`);
        });

        log('\nðŸŽ‰ Test completed successfully!');
        log('âœ… Layer ID stability confirmed!');
    </script>
</body>
</html>
