<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Settings Save/Load Cycle Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1f2937; color: white; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #374151; border-radius: 8px; }
        .test-button { padding: 10px 20px; margin: 5px; background: #3b82f6; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .test-button:hover { background: #2563eb; }
        .result { margin: 10px 0; padding: 10px; background: #111827; border-radius: 4px; }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
        .warning { border-left: 4px solid #f59e0b; }
        pre { background: #000; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Grid Settings Save/Load Cycle Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Clear All Settings</h2>
        <p>Clear all existing settings to start fresh</p>
        <button class="test-button" onclick="clearAllSettings()">Clear All Settings</button>
        <div id="clear-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Simulate Save Changes</h2>
        <p>Simulate what happens when user clicks "Save Changes" in settings panel</p>
        <button class="test-button" onclick="simulateSaveChanges()">Simulate Save Changes</button>
        <div id="save-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Check Saved Settings</h2>
        <p>Check what was actually saved to localStorage</p>
        <button class="test-button" onclick="checkSavedSettings()">Check Saved Settings</button>
        <div id="check-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Simulate Editor Restart</h2>
        <p>Simulate what happens when editor restarts and loads settings</p>
        <button class="test-button" onclick="simulateEditorRestart()">Simulate Editor Restart</button>
        <div id="restart-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 5: Verify Grid Settings Applied</h2>
        <p>Verify that grid settings are properly applied to StateManager</p>
        <button class="test-button" onclick="verifyGridSettings()">Verify Grid Settings</button>
        <div id="verify-result" class="result"></div>
    </div>

    <script>
        // Simulate ConfigManager
        class TestConfigManager {
            constructor() {
                this.configs = {
                    grid: {
                        size: 32,
                        color: '#ffffff',
                        opacity: 0.1,
                        thickness: 1,
                        subdivisions: 4,
                        subdivColor: '#666666',
                        subdivThickness: 0.5,
                        showGrid: true
                    }
                };
            }
            
            get(key) {
                const keys = key.split('.');
                let value = this.configs;
                for (const k of keys) {
                    value = value?.[k];
                }
                return value;
            }
            
            set(key, value) {
                const keys = key.split('.');
                let obj = this.configs;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!obj[keys[i]]) obj[keys[i]] = {};
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            }
            
            saveSettings() {
                // Simulate saving to localStorage
                const gridConfig = this.configs.grid;
                localStorage.setItem('levelEditor_config_grid', JSON.stringify(gridConfig));
                console.log('Saved grid config to localStorage:', gridConfig);
            }
            
            loadUserConfig(configName) {
                if (configName === 'grid') {
                    const stored = localStorage.getItem('levelEditor_config_grid');
                    if (stored) {
                        return JSON.parse(stored);
                    }
                }
                return null;
            }
        }

        // Simulate StateManager
        class TestStateManager {
            constructor() {
                this.state = {
                    canvas: {
                        gridSize: 32,
                        gridColor: 'rgba(255, 255, 255, 0.1)',
                        gridThickness: 1,
                        gridOpacity: 0.1,
                        gridSubdivisions: 4,
                        gridSubdivColor: 'rgba(102, 102, 102, 0.1)',
                        gridSubdivThickness: 0.5
                    }
                };
            }
            
            get(key) {
                const keys = key.split('.');
                let value = this.state;
                for (const k of keys) {
                    value = value?.[k];
                }
                return value;
            }
            
            set(key, value) {
                const keys = key.split('.');
                let obj = this.state;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!obj[keys[i]]) obj[keys[i]] = {};
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            }
        }

        // Simulate GridSettings
        class TestGridSettings {
            constructor(configManager) {
                this.configManager = configManager;
            }
            
            syncAllGridSettingsToState() {
                const gridSize = this.configManager.get('grid.size') ?? 32;
                const gridColor = this.configManager.get('grid.color') ?? '#ffffff';
                const gridThickness = this.configManager.get('grid.thickness') ?? 1;
                const gridOpacity = this.configManager.get('grid.opacity') ?? 0.1;
                const gridSubdivisions = this.configManager.get('grid.subdivisions') ?? 4;
                const gridSubdivColor = this.configManager.get('grid.subdivColor') ?? '#666666';
                const gridSubdivThickness = this.configManager.get('grid.subdivThickness') ?? 0.5;

                console.log('GridSettings.syncAllGridSettingsToState called:', {
                    fromConfigManager: { gridSize, gridColor, gridThickness, gridOpacity, gridSubdivisions, gridSubdivColor, gridSubdivThickness }
                });

                // Convert and set each parameter
                window.stateManager.set('canvas.gridSize', gridSize);

                // Convert main grid color
                let colorValue = gridColor;
                if (gridColor.startsWith('#')) {
                    const r = parseInt(gridColor.slice(1, 3), 16);
                    const g = parseInt(gridColor.slice(3, 5), 16);
                    const b = parseInt(gridColor.slice(5, 7), 16);
                    colorValue = `rgba(${r}, ${g}, ${b}, ${gridOpacity})`;
                }
                window.stateManager.set('canvas.gridColor', colorValue);

                window.stateManager.set('canvas.gridThickness', gridThickness);
                window.stateManager.set('canvas.gridOpacity', gridOpacity);
                window.stateManager.set('canvas.gridSubdivisions', gridSubdivisions);

                // Convert subdivision color
                let subdivColorValue = gridSubdivColor;
                if (gridSubdivColor.startsWith('#')) {
                    const r = parseInt(gridSubdivColor.slice(1, 3), 16);
                    const g = parseInt(gridSubdivColor.slice(3, 5), 16);
                    const b = parseInt(gridSubdivColor.slice(5, 7), 16);
                    subdivColorValue = `rgba(${r}, ${g}, ${b}, ${gridOpacity})`;
                }
                window.stateManager.set('canvas.gridSubdivColor', subdivColorValue);

                window.stateManager.set('canvas.gridSubdivThickness', gridSubdivThickness);
            }
        }

        // Initialize test components
        window.configManager = new TestConfigManager();
        window.stateManager = new TestStateManager();
        window.gridSettings = new TestGridSettings(window.configManager);

        function clearAllSettings() {
            const resultDiv = document.getElementById('clear-result');
            
            // Clear localStorage
            localStorage.removeItem('levelEditor_config_grid');
            localStorage.removeItem('levelEditor_userPrefs');
            
            // Reset components
            window.configManager = new TestConfigManager();
            window.stateManager = new TestStateManager();
            window.gridSettings = new TestGridSettings(window.configManager);
            
            resultDiv.innerHTML = '<div class="success">✅ All settings cleared!</div>';
        }

        function simulateSaveChanges() {
            const resultDiv = document.getElementById('save-result');
            
            // Simulate user changing grid settings in UI
            const customSettings = {
                size: 64,
                color: '#ff0000',
                opacity: 0.3,
                thickness: 2,
                subdivisions: 8,
                subdivColor: '#00ff00',
                subdivThickness: 1.5
            };
            
            // Simulate what happens in SettingsPanel.saveSettings()
            console.log('Simulating SettingsPanel.saveSettings()...');
            
            // Save current grid settings from StateManager to ConfigManager
            window.stateManager.set('canvas.gridSize', customSettings.size);
            window.stateManager.set('canvas.gridColor', `rgba(255, 0, 0, ${customSettings.opacity})`);
            window.stateManager.set('canvas.gridThickness', customSettings.thickness);
            window.stateManager.set('canvas.gridOpacity', customSettings.opacity);
            window.stateManager.set('canvas.gridSubdivisions', customSettings.subdivisions);
            window.stateManager.set('canvas.gridSubdivColor', `rgba(0, 255, 0, ${customSettings.opacity})`);
            window.stateManager.set('canvas.gridSubdivThickness', customSettings.subdivThickness);
            
            // Save to ConfigManager
            window.configManager.set('grid.size', customSettings.size);
            window.configManager.set('grid.color', customSettings.color);
            window.configManager.set('grid.thickness', customSettings.thickness);
            window.configManager.set('grid.opacity', customSettings.opacity);
            window.configManager.set('grid.subdivisions', customSettings.subdivisions);
            window.configManager.set('grid.subdivColor', customSettings.subdivColor);
            window.configManager.set('grid.subdivThickness', customSettings.subdivThickness);
            
            // Save to localStorage
            window.configManager.saveSettings();
            
            resultDiv.innerHTML = `
                <div class="success">✅ Save Changes simulated successfully!</div>
                <div class="info">
                    <h3>Custom settings applied:</h3>
                    <pre>${JSON.stringify(customSettings, null, 2)}</pre>
                </div>
            `;
        }

        function checkSavedSettings() {
            const resultDiv = document.getElementById('check-result');
            
            const savedGridConfig = localStorage.getItem('levelEditor_config_grid');
            const currentConfigManager = window.configManager.configs.grid;
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h3>localStorage (levelEditor_config_grid):</h3>
                    <pre>${savedGridConfig || 'No data'}</pre>
                </div>
                <div class="info">
                    <h3>ConfigManager current state:</h3>
                    <pre>${JSON.stringify(currentConfigManager, null, 2)}</pre>
                </div>
            `;
        }

        function simulateEditorRestart() {
            const resultDiv = document.getElementById('restart-result');
            
            // Simulate editor restart - create new instances
            const newConfigManager = new TestConfigManager();
            const newStateManager = new TestStateManager();
            
            // Simulate loadUserConfigsFromStorage() - load from localStorage
            const savedGridConfig = localStorage.getItem('levelEditor_config_grid');
            if (savedGridConfig) {
                const loadedConfig = JSON.parse(savedGridConfig);
                newConfigManager.configs.grid = { ...newConfigManager.configs.grid, ...loadedConfig };
                console.log('Loaded grid config from localStorage:', loadedConfig);
            }
            
            // Simulate applyConfiguration() - apply settings to StateManager
            const gridSize = newConfigManager.get('grid.size');
            const gridColor = newConfigManager.get('grid.color');
            const gridThickness = newConfigManager.get('grid.thickness');
            const gridOpacity = newConfigManager.get('grid.opacity');
            const gridSubdivisions = newConfigManager.get('grid.subdivisions');
            const gridSubdivColor = newConfigManager.get('grid.subdivColor');
            const gridSubdivThickness = newConfigManager.get('grid.subdivThickness');

            console.log('Loading grid settings from ConfigManager:', {
                gridSize, gridColor, gridThickness, gridOpacity,
                gridSubdivisions, gridSubdivColor, gridSubdivThickness
            });

            // Apply settings to StateManager
            if (gridSize !== undefined) {
                newStateManager.set('canvas.gridSize', gridSize);
            }
            if (gridColor !== undefined) {
                let colorValue = gridColor;
                if (gridColor.startsWith('#')) {
                    const opacity = gridOpacity !== undefined ? gridOpacity : 0.1;
                    const r = parseInt(gridColor.slice(1, 3), 16);
                    const g = parseInt(gridColor.slice(3, 5), 16);
                    const b = parseInt(gridColor.slice(5, 7), 16);
                    colorValue = `rgba(${r}, ${g}, ${b}, ${opacity})`;
                }
                newStateManager.set('canvas.gridColor', colorValue);
            }
            if (gridThickness !== undefined) {
                newStateManager.set('canvas.gridThickness', gridThickness);
            }
            if (gridOpacity !== undefined) {
                newStateManager.set('canvas.gridOpacity', gridOpacity);
            }
            if (gridSubdivisions !== undefined) {
                newStateManager.set('canvas.gridSubdivisions', gridSubdivisions);
            }
            if (gridSubdivColor !== undefined) {
                let subdivColorValue = gridSubdivColor;
                if (gridSubdivColor.startsWith('#')) {
                    const opacity = gridOpacity !== undefined ? gridOpacity : 0.1;
                    const r = parseInt(gridSubdivColor.slice(1, 3), 16);
                    const g = parseInt(gridSubdivColor.slice(3, 5), 16);
                    const b = parseInt(gridSubdivColor.slice(5, 7), 16);
                    subdivColorValue = `rgba(${r}, ${g}, ${b}, ${opacity})`;
                }
                newStateManager.set('canvas.gridSubdivColor', subdivColorValue);
            }
            if (gridSubdivThickness !== undefined) {
                newStateManager.set('canvas.gridSubdivThickness', gridSubdivThickness);
            }
            
            // Sync grid settings (this is the fix we added)
            const newGridSettings = new TestGridSettings(newConfigManager);
            newGridSettings.syncAllGridSettingsToState();
            
            // Update global references
            window.configManager = newConfigManager;
            window.stateManager = newStateManager;
            window.gridSettings = newGridSettings;
            
            const finalState = newStateManager.state.canvas;
            
            resultDiv.innerHTML = `
                <div class="success">✅ Editor restart simulated successfully!</div>
                <div class="info">
                    <h3>Final StateManager state after restart:</h3>
                    <pre>${JSON.stringify(finalState, null, 2)}</pre>
                </div>
            `;
        }

        function verifyGridSettings() {
            const resultDiv = document.getElementById('verify-result');
            
            const currentState = window.stateManager.state.canvas;
            const expectedSettings = {
                gridSize: 64,
                gridColor: 'rgba(255, 0, 0, 0.3)',
                gridThickness: 2,
                gridOpacity: 0.3,
                gridSubdivisions: 8,
                gridSubdivColor: 'rgba(0, 255, 0, 0.3)',
                gridSubdivThickness: 1.5
            };
            
            let allCorrect = true;
            const issues = [];
            
            for (const [key, expectedValue] of Object.entries(expectedSettings)) {
                const actualValue = currentState[key];
                if (actualValue !== expectedValue) {
                    allCorrect = false;
                    issues.push(`${key}: expected ${expectedValue}, got ${actualValue}`);
                }
            }
            
            if (allCorrect) {
                resultDiv.innerHTML = `
                    <div class="success">✅ All grid settings are correctly applied!</div>
                    <div class="info">
                        <h3>Current StateManager state:</h3>
                        <pre>${JSON.stringify(currentState, null, 2)}</pre>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">❌ Grid settings are NOT correctly applied!</div>
                    <div class="warning">
                        <h3>Issues found:</h3>
                        <ul>
                            ${issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="info">
                        <h3>Current StateManager state:</h3>
                        <pre>${JSON.stringify(currentState, null, 2)}</pre>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
