<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Settings Restoration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1f2937; color: white; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #374151; border-radius: 8px; }
        .test-button { padding: 10px 20px; margin: 5px; background: #3b82f6; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .test-button:hover { background: #2563eb; }
        .result { margin: 10px 0; padding: 10px; background: #111827; border-radius: 4px; }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <h1>Grid Settings Restoration Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Save Grid Settings</h2>
        <p>This will save custom grid settings to localStorage</p>
        <button class="test-button" onclick="saveGridSettings()">Save Custom Grid Settings</button>
        <div id="save-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Check Saved Settings</h2>
        <p>This will check what settings are stored in localStorage</p>
        <button class="test-button" onclick="checkSavedSettings()">Check Saved Settings</button>
        <div id="check-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Simulate Editor Initialization</h2>
        <p>This will simulate how the editor loads settings on startup</p>
        <button class="test-button" onclick="simulateEditorInit()">Simulate Editor Init</button>
        <div id="init-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Clear Settings</h2>
        <p>This will clear all saved settings</p>
        <button class="test-button" onclick="clearSettings()">Clear Settings</button>
        <div id="clear-result" class="result"></div>
    </div>

    <script>
        // Simulate UserPreferencesManager
        class TestUserPreferencesManager {
            constructor() {
                this.prefsKey = 'levelEditor_userPrefs';
                this.defaultPrefs = {
                    gridSize: 32,
                    showGrid: true,
                    gridColor: '#ffffff',
                    gridOpacity: 0.1,
                    gridThickness: 1,
                    gridSubdivisions: 4,
                    gridSubdivColor: '#666666',
                    gridSubdivThickness: 0.5
                };
            }
            
            loadPreferences() {
                try {
                    const stored = localStorage.getItem(this.prefsKey);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        return { ...this.defaultPrefs, ...parsed };
                    }
                } catch (error) {
                    console.error('Failed to load preferences:', error);
                }
                return { ...this.defaultPrefs };
            }
            
            savePreferences() {
                try {
                    localStorage.setItem(this.prefsKey, JSON.stringify(this.preferences));
                    return true;
                } catch (error) {
                    console.error('Failed to save preferences:', error);
                    return false;
                }
            }
            
            get(key) {
                return this.preferences[key];
            }
            
            set(key, value) {
                this.preferences[key] = value;
                this.savePreferences();
            }
        }

        // Simulate ConfigManager
        class TestConfigManager {
            constructor() {
                this.configs = {
                    grid: {
                        size: 32,
                        color: '#ffffff',
                        opacity: 0.1,
                        thickness: 1,
                        subdivisions: 4,
                        subdivColor: '#666666',
                        subdivThickness: 0.5
                    }
                };
            }
            
            get(key) {
                const keys = key.split('.');
                let value = this.configs;
                for (const k of keys) {
                    value = value?.[k];
                }
                return value;
            }
            
            set(key, value) {
                const keys = key.split('.');
                let obj = this.configs;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!obj[keys[i]]) obj[keys[i]] = {};
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            }
        }

        // Simulate StateManager
        class TestStateManager {
            constructor() {
                this.state = {
                    canvas: {
                        gridSize: 32,
                        gridColor: 'rgba(255, 255, 255, 0.1)',
                        gridThickness: 1,
                        gridOpacity: 0.1,
                        gridSubdivisions: 4,
                        gridSubdivColor: 'rgba(102, 102, 102, 0.1)',
                        gridSubdivThickness: 0.5
                    }
                };
            }
            
            get(key) {
                const keys = key.split('.');
                let value = this.state;
                for (const k of keys) {
                    value = value?.[k];
                }
                return value;
            }
            
            set(key, value) {
                const keys = key.split('.');
                let obj = this.state;
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!obj[keys[i]]) obj[keys[i]] = {};
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            }
        }

        // Simulate GridSettings
        class TestGridSettings {
            constructor(configManager) {
                this.configManager = configManager;
            }
            
            syncAllGridSettingsToState() {
                const gridSize = this.configManager.get('grid.size') ?? 32;
                const gridColor = this.configManager.get('grid.color') ?? '#ffffff';
                const gridThickness = this.configManager.get('grid.thickness') ?? 1;
                const gridOpacity = this.configManager.get('grid.opacity') ?? 0.1;
                const gridSubdivisions = this.configManager.get('grid.subdivisions') ?? 4;
                const gridSubdivColor = this.configManager.get('grid.subdivColor') ?? '#666666';
                const gridSubdivThickness = this.configManager.get('grid.subdivThickness') ?? 0.5;

                console.log('GridSettings.syncAllGridSettingsToState called:', {
                    fromConfigManager: { gridSize, gridColor, gridThickness, gridOpacity, gridSubdivisions, gridSubdivColor, gridSubdivThickness }
                });

                // Convert and set each parameter
                window.stateManager.set('canvas.gridSize', gridSize);

                // Convert main grid color
                let colorValue = gridColor;
                if (gridColor.startsWith('#')) {
                    const r = parseInt(gridColor.slice(1, 3), 16);
                    const g = parseInt(gridColor.slice(3, 5), 16);
                    const b = parseInt(gridColor.slice(5, 7), 16);
                    colorValue = `rgba(${r}, ${g}, ${b}, ${gridOpacity})`;
                }
                window.stateManager.set('canvas.gridColor', colorValue);

                window.stateManager.set('canvas.gridThickness', gridThickness);
                window.stateManager.set('canvas.gridOpacity', gridOpacity);
                window.stateManager.set('canvas.gridSubdivisions', gridSubdivisions);

                // Convert subdivision color
                let subdivColorValue = gridSubdivColor;
                if (gridSubdivColor.startsWith('#')) {
                    const r = parseInt(gridSubdivColor.slice(1, 3), 16);
                    const g = parseInt(gridSubdivColor.slice(3, 5), 16);
                    const b = parseInt(gridSubdivColor.slice(5, 7), 16);
                    subdivColorValue = `rgba(${r}, ${g}, ${b}, ${gridOpacity})`;
                }
                window.stateManager.set('canvas.gridSubdivColor', subdivColorValue);

                window.stateManager.set('canvas.gridSubdivThickness', gridSubdivThickness);
            }
        }

        // Initialize test components
        window.userPrefs = new TestUserPreferencesManager();
        window.configManager = new TestConfigManager();
        window.stateManager = new TestStateManager();
        window.gridSettings = new TestGridSettings(window.configManager);

        function saveGridSettings() {
            const resultDiv = document.getElementById('save-result');
            
            // Save custom grid settings
            window.userPrefs.set('gridSize', 64);
            window.userPrefs.set('gridColor', '#ff0000');
            window.userPrefs.set('gridOpacity', 0.3);
            window.userPrefs.set('gridThickness', 2);
            window.userPrefs.set('gridSubdivisions', 8);
            window.userPrefs.set('gridSubdivColor', '#00ff00');
            window.userPrefs.set('gridSubdivThickness', 1.5);
            
            // Also save to ConfigManager
            window.configManager.set('grid.size', 64);
            window.configManager.set('grid.color', '#ff0000');
            window.configManager.set('grid.opacity', 0.3);
            window.configManager.set('grid.thickness', 2);
            window.configManager.set('grid.subdivisions', 8);
            window.configManager.set('grid.subdivColor', '#00ff00');
            window.configManager.set('grid.subdivThickness', 1.5);
            
            resultDiv.innerHTML = '<div class="success">✅ Custom grid settings saved successfully!</div>';
        }

        function checkSavedSettings() {
            const resultDiv = document.getElementById('check-result');
            const saved = window.userPrefs.loadPreferences();
            const config = window.configManager.configs.grid;
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h3>UserPreferencesManager:</h3>
                    <pre>${JSON.stringify(saved, null, 2)}</pre>
                </div>
                <div class="info">
                    <h3>ConfigManager:</h3>
                    <pre>${JSON.stringify(config, null, 2)}</pre>
                </div>
            `;
        }

        function simulateEditorInit() {
            const resultDiv = document.getElementById('init-result');
            
            // Simulate the fixed applyConfiguration method
            const gridSize = window.configManager.get('grid.size');
            const gridColor = window.configManager.get('grid.color');
            const gridThickness = window.configManager.get('grid.thickness');
            const gridOpacity = window.configManager.get('grid.opacity');
            const gridSubdivisions = window.configManager.get('grid.subdivisions');
            const gridSubdivColor = window.configManager.get('grid.subdivColor');
            const gridSubdivThickness = window.configManager.get('grid.subdivThickness');

            console.log('Loading grid settings from ConfigManager:', {
                gridSize, gridColor, gridThickness, gridOpacity,
                gridSubdivisions, gridSubdivColor, gridSubdivThickness
            });

            // Apply settings to StateManager
            if (gridSize !== undefined) {
                window.stateManager.set('canvas.gridSize', gridSize);
            }
            if (gridColor !== undefined) {
                let colorValue = gridColor;
                if (gridColor.startsWith('#')) {
                    const opacity = gridOpacity !== undefined ? gridOpacity : 0.1;
                    const r = parseInt(gridColor.slice(1, 3), 16);
                    const g = parseInt(gridColor.slice(3, 5), 16);
                    const b = parseInt(gridColor.slice(5, 7), 16);
                    colorValue = `rgba(${r}, ${g}, ${b}, ${opacity})`;
                }
                window.stateManager.set('canvas.gridColor', colorValue);
            }
            if (gridThickness !== undefined) {
                window.stateManager.set('canvas.gridThickness', gridThickness);
            }
            if (gridOpacity !== undefined) {
                window.stateManager.set('canvas.gridOpacity', gridOpacity);
            }
            if (gridSubdivisions !== undefined) {
                window.stateManager.set('canvas.gridSubdivisions', gridSubdivisions);
            }
            if (gridSubdivColor !== undefined) {
                let subdivColorValue = gridSubdivColor;
                if (gridSubdivColor.startsWith('#')) {
                    const opacity = gridOpacity !== undefined ? gridOpacity : 0.1;
                    const r = parseInt(gridSubdivColor.slice(1, 3), 16);
                    const g = parseInt(gridSubdivColor.slice(3, 5), 16);
                    const b = parseInt(gridSubdivColor.slice(5, 7), 16);
                    subdivColorValue = `rgba(${r}, ${g}, ${b}, ${opacity})`;
                }
                window.stateManager.set('canvas.gridSubdivColor', subdivColorValue);
            }
            if (gridSubdivThickness !== undefined) {
                window.stateManager.set('canvas.gridSubdivThickness', gridSubdivThickness);
            }
            
            // Sync grid settings (this is the fix we added)
            window.gridSettings.syncAllGridSettingsToState();
            
            const finalState = window.stateManager.state.canvas;
            
            resultDiv.innerHTML = `
                <div class="success">✅ Editor initialization simulated successfully!</div>
                <div class="info">
                    <h3>Final StateManager state:</h3>
                    <pre>${JSON.stringify(finalState, null, 2)}</pre>
                </div>
            `;
        }

        function clearSettings() {
            const resultDiv = document.getElementById('clear-result');
            localStorage.removeItem('levelEditor_userPrefs');
            window.userPrefs = new TestUserPreferencesManager();
            window.configManager = new TestConfigManager();
            window.stateManager = new TestStateManager();
            window.gridSettings = new TestGridSettings(window.configManager);
            resultDiv.innerHTML = '<div class="success">✅ All settings cleared!</div>';
        }
    </script>
</body>
</html>
