<!DOCTYPE html>
<html>
<head>
    <title>Debug Grid Settings</title>
    <style>
        body { margin: 0; background: #1f2937; color: white; font-family: monospace; }
        canvas { border: 1px solid #374151; }
        .controls { padding: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
        .control-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; }
        input, button { padding: 5px; background: #374151; border: 1px solid #4b5563; border-radius: 4px; color: white; }
        button { cursor: pointer; background: #3b82f6; }
        button:hover { background: #2563eb; }
    </style>
</head>
<body>
    <div class="controls">
        <div class="control-group">
            <label>Grid Size: <input type="number" id="gridSize" value="32" min="8" max="128"></label>
        </div>
        <div class="control-group">
            <label>Grid Color: <input type="color" id="gridColor" value="#ffffff"></label>
        </div>
        <div class="control-group">
            <label>Grid Opacity: <input type="range" id="gridOpacity" value="0.1" min="0" max="1" step="0.05"></label>
        </div>
        <div class="control-group">
            <label>Grid Thickness: <input type="number" id="gridThickness" value="1" min="0.1" max="5" step="0.1"></label>
        </div>
        <div class="control-group">
            <label>Subdivisions: <input type="number" id="gridSubdivisions" value="4" min="1" max="10"></label>
        </div>
        <div class="control-group">
            <label>Subdiv Color: <input type="color" id="gridSubdivColor" value="#666666"></label>
        </div>
        <button onclick="updateGrid()">Update Grid</button>
        <button onclick="resetToDefaults()">Reset to Defaults</button>
        <button onclick="testStateManager()">Test StateManager</button>
    </div>
    <canvas id="canvas" width="1200" height="800"></canvas>

    <script type="module">
        import { StateManager } from './src/managers/StateManager.js';
        import { CanvasRenderer } from './src/ui/CanvasRenderer.js';

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Initialize components
        const stateManager = new StateManager();
        const canvasRenderer = new CanvasRenderer(canvas);

        // Mock camera
        const camera = { x: 0, y: 0, zoom: 1 };

        // Mock level with basic settings
        const mockLevel = {
            settings: {
                showGrid: true,
                backgroundColor: '#4B5563',
                gridSize: 32
            }
        };

        // Mock editor object
        const mockEditor = {
            stateManager,
            level: mockLevel,
            canvasRenderer
        };

        // Mock renderOperations
        const renderOperations = {
            editor: mockEditor
        };

        // Function to update grid from inputs
        window.updateGrid = function() {
            const gridSize = parseInt(document.getElementById('gridSize').value);
            const gridColor = document.getElementById('gridColor').value;
            const gridOpacity = parseFloat(document.getElementById('gridOpacity').value);
            const gridThickness = parseFloat(document.getElementById('gridThickness').value);
            const gridSubdivisions = parseInt(document.getElementById('gridSubdivisions').value);
            const gridSubdivColor = document.getElementById('gridSubdivColor').value;

            console.log('Updating grid settings:', {
                gridSize, gridColor, gridOpacity, gridThickness, gridSubdivisions, gridSubdivColor
            });

            // Set values in StateManager
            stateManager.set('canvas.gridSize', gridSize);

            // Convert hex color to rgba
            const r = parseInt(gridColor.slice(1, 3), 16);
            const g = parseInt(gridColor.slice(3, 5), 16);
            const b = parseInt(gridColor.slice(5, 7), 16);
            const colorValue = `rgba(${r}, ${g}, ${b}, ${gridOpacity})`;
            stateManager.set('canvas.gridColor', colorValue);

            stateManager.set('canvas.gridThickness', gridThickness);
            stateManager.set('canvas.gridOpacity', gridOpacity);
            stateManager.set('canvas.gridSubdivisions', gridSubdivisions);

            // Convert subdiv color
            const sr = parseInt(gridSubdivColor.slice(1, 3), 16);
            const sg = parseInt(gridSubdivColor.slice(3, 5), 16);
            const sb = parseInt(gridSubdivColor.slice(5, 7), 16);
            const subdivColorValue = `rgba(${sr}, ${sg}, ${sb}, ${gridOpacity})`;
            stateManager.set('canvas.gridSubdivColor', subdivColorValue);

            stateManager.set('canvas.gridSubdivThickness', 0.5);

            // Trigger render
            renderGrid();
        };

        window.resetToDefaults = function() {
            document.getElementById('gridSize').value = 32;
            document.getElementById('gridColor').value = '#ffffff';
            document.getElementById('gridOpacity').value = 0.1;
            document.getElementById('gridThickness').value = 1;
            document.getElementById('gridSubdivisions').value = 4;
            document.getElementById('gridSubdivColor').value = '#666666';
            updateGrid();
        };

        window.testStateManager = function() {
            console.log('StateManager values:');
            console.log('canvas.gridSize:', stateManager.get('canvas.gridSize'));
            console.log('canvas.gridColor:', stateManager.get('canvas.gridColor'));
            console.log('canvas.gridThickness:', stateManager.get('canvas.gridThickness'));
            console.log('canvas.gridOpacity:', stateManager.get('canvas.gridOpacity'));
            console.log('canvas.gridSubdivisions:', stateManager.get('canvas.gridSubdivisions'));
            console.log('canvas.gridSubdivColor:', stateManager.get('canvas.gridSubdivColor'));
            console.log('canvas.gridSubdivThickness:', stateManager.get('canvas.gridSubdivThickness'));
        };

        function renderGrid() {
            // Get grid parameters from StateManager (like in RenderOperations)
            const showGrid = stateManager.get('canvas.showGrid') ?? mockLevel.settings.showGrid;
            const gridSize = stateManager.get('canvas.gridSize') ?? mockLevel.settings.gridSize;
            const gridColor = stateManager.get('canvas.gridColor') ?? 'rgba(255, 255, 255, 0.1)';
            const gridThickness = stateManager.get('canvas.gridThickness') ?? 1;
            const gridOpacity = stateManager.get('canvas.gridOpacity') ?? 0.1;
            const gridSubdivisions = stateManager.get('canvas.gridSubdivisions') ?? 4;
            const gridSubdivColor = stateManager.get('canvas.gridSubdivColor') ?? '#666666';
            const gridSubdivThickness = stateManager.get('canvas.gridSubdivThickness') ?? 0.5;

            console.log('Rendering grid with:', {
                showGrid, gridSize, gridColor, gridThickness, gridOpacity,
                gridSubdivisions, gridSubdivColor, gridSubdivThickness
            });

            if (showGrid) {
                canvasRenderer.drawGrid(
                    gridSize,
                    camera,
                    mockLevel.settings.backgroundColor,
                    {
                        color: gridColor,
                        thickness: gridThickness,
                        opacity: gridOpacity,
                        subdivisions: gridSubdivisions,
                        subdivColor: gridSubdivColor,
                        subdivThickness: gridSubdivThickness
                    }
                );
            }
        }

        // Initial render
        updateGrid();

        // Update on input changes
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', updateGrid);
        });
    </script>
</body>
</html>
